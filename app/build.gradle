// –ü–ª–∞–≥–∏–Ω—ã
plugins {
    id 'java'
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.1.0'
    id 'com.github.johnrengelman.shadow' version '7.1.2'
    id 'edu.sc.seis.launch4j' version '2.5.4'
}

group = 'musicsearch'
version = '1.0.0'
mainClassName = 'musicsearch.App'

// JavaFX-–º–æ–¥—É–ª–∏
javafx {
    version = "21"
    modules = [ 'javafx.controls', 'javafx.fxml', 'javafx.media' ]
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.jsoup:jsoup:1.21.2'
    implementation 'com.google.code.gson:gson:2.10.1'
    compileOnly 'org.projectlombok:lombok:1.18.30'
    annotationProcessor 'org.projectlombok:lombok:1.18.30'
    testImplementation 'org.junit.jupiter:junit-jupiter:5.10.2'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher:1.10.2'
    implementation 'com.google.guava:guava:32.1.2-jre'
    implementation 'io.github.cdimascio:dotenv-java:3.2.0'
    implementation 'org:jaudiotagger:2.0.3'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

application {
    mainClass = 'musicsearch.App'
}

tasks.named('test') {
    useJUnitPlatform()
}

// –°–æ–∑–¥–∞–µ–º fat JAR
shadowJar {
    archiveBaseName.set('MusicSearch')
    archiveClassifier.set('')
    archiveVersion.set(version)
    mergeServiceFiles()
    
    manifest {
        attributes(
            'Main-Class': mainClassName,
            'Implementation-Version': version
        )
    }
}

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –≤ —Ä–µ—Å—É—Ä—Å—ã
task copyEnv(type: Copy) {
    from '.env'
    into 'build/resources/main'
}

processResources.dependsOn copyEnv

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Launch4j - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
launch4j {
    mainClassName = 'musicsearch.App'
    // –£–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–¥–∞—á—É, –∞ –Ω–µ —Ñ–∞–π–ª - —ç—Ç–æ –≤–∞–∂–Ω–æ!
    jarTask = project.tasks.shadowJar
    outfile = 'MusicSearch.exe'
    icon = "${projectDir}/src/main/resources/icon.ico"    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ JVM –¥–ª—è JavaFX
    jvmOptions = [
        '--module-path=%JAVAFX_HOME%/lib',
        '--add-modules=javafx.controls,javafx.fxml,javafx.media',
        '-Dfile.encoding=UTF-8',
        '-Xmx512m'
    ]
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Java
    jreMinVersion = '21'
    maxHeapSize = 512
    bundledJrePath = '%JAVA_HOME%'
    
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏
    version = project.version
    textVersion = project.version
    copyright = 'MusicSearch 2024'
    companyName = 'MusicSearch'
    fileDescription = 'Music Search Application'
    productName = 'MusicSearch'
}

// –°–æ–∑–¥–∞–µ–º portable –≤–µ—Ä—Å–∏—é —Å EXE
task createPortableWithExe {
    dependsOn createExe
    
    doLast {
        def portableDir = file("${buildDir}/portable-exe/MusicSearch")
        portableDir.mkdirs()
        
        // –ö–æ–ø–∏—Ä—É–µ–º EXE —Ñ–∞–π–ª –∏–∑ –ø–∞–ø–∫–∏ launch4j
        copy {
            from "${buildDir}/launch4j"
            include "MusicSearch.exe"
            into portableDir
        }
        
        // –ö–æ–ø–∏—Ä—É–µ–º .env —Ñ–∞–π–ª
        def envFile = file('.env')
        if (envFile.exists()) {
            copy {
                from envFile
                into portableDir
            }
            println "‚úì .env —Ñ–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"
        }
        
        // –ö–æ–ø–∏—Ä—É–µ–º –∏–∫–æ–Ω–∫—É –≤ portable –≤–µ—Ä—Å–∏—é (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
        def iconFile = file("${projectDir}/src/main/resources/icon.ico")
        if (iconFile.exists()) {
            copy {
                from iconFile
                into portableDir
            }
            println "‚úì –ò–∫–æ–Ω–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ portable –≤–µ—Ä—Å–∏—é"
        }
        
        // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
        // –ö–æ–ø–∏—Ä—É–µ–º JAR –¥–ª—è BAT —Ñ–∞–π–ª–∞
        copy {
            from shadowJar.archiveFile
            into portableDir
            rename { 'MusicSearch.jar' }
        }
        
        // –°–æ–∑–¥–∞–µ–º BAT —Ñ–∞–π–ª
        def batFile = new File("${portableDir}/MusicSearch.bat")
        batFile.text = """@echo off
chcp 65001 >nul
title MusicSearch
echo ========================================
echo    MusicSearch - BAT Launcher
echo ========================================
echo.

:: –ü—Ä–æ–≤–µ—Ä–∫–∞ Java
echo [1/3] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Java...
java -version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå –û–®–ò–ë–ö–ê: Java –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ –Ω–µ –≤ PATH
    echo.
    echo –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Java 21+ —Å JavaFX:
    echo https://adoptium.net/temurin/releases/?version=21&package=jdk-fx
    echo.
    pause
    exit /b 1
)
echo ‚úì Java –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞
echo.

:: –ü—Ä–æ–≤–µ—Ä–∫–∞ JAR
echo [2/3] –ü—Ä–æ–≤–µ—Ä–∫–∞ JAR —Ñ–∞–π–ª–∞...
if not exist "MusicSearch.jar" (
    echo ‚ùå –û–®–ò–ë–ö–ê: MusicSearch.jar –Ω–µ –Ω–∞–π–¥–µ–Ω
    pause
    exit /b 1
)
echo ‚úì JAR —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω
echo.

:: –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo [3/3] –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...
echo.
java -jar MusicSearch.jar

pause
"""
        
        println "=" * 60
        println "Portable –≤–µ—Ä—Å–∏—è —Å EXE —Å–æ–∑–¥–∞–Ω–∞: ${portableDir}"
        println "–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª: MusicSearch.exe (—Å –∏–∫–æ–Ω–∫–æ–π)"
        println "–ó–∞–ø–∞—Å–Ω–æ–π —Ñ–∞–π–ª: MusicSearch.bat"
        println "=" * 60
    }
}

task createExeZip(type: Zip) {
    dependsOn createPortableWithExe
    from "${buildDir}/portable-exe"
    archiveFileName = "MusicSearch-${version}-windows.exe.zip"
    destinationDirectory = file("${buildDir}/distributions")
    
    doLast {
        println "‚úì ZIP –∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: build/distributions/MusicSearch-${version}-windows.exe.zip"
    }
}

// –ì–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞
task buildWithExe {
    dependsOn createExeZip
    doLast {
        println "=" * 60
        println "üéâ EXE –í–ï–†–°–ò–Ø –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù–ê!"
        println "üìÅ –§–∞–π–ª: build/distributions/MusicSearch-${version}-windows.exe.zip"
        println ""
        println "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
        println "  ‚úÖ MusicSearch.exe - –∑–∞–ø—É—Å–∫–∞–µ–º—ã–π —Ñ–∞–π–ª —á–µ—Ä–µ–∑ Launch4j"
        println "  üîß MusicSearch.bat - —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ (–∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)"
        println "  üì¶ MusicSearch.jar - JAR —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
        println "  ‚öôÔ∏è  .env - —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
        println ""
        println "üöÄ –ó–∞–ø—É—Å–∫:"
        println "  1. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤ –≤ –ª—é–±—É—é –ø–∞–ø–∫—É"
        println "  2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ MusicSearch.exe"
        println "  3. –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã - –∑–∞–ø—É—Å—Ç–∏—Ç–µ MusicSearch.bat"
        println ""
        println "üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ Java 21+ —Å JavaFX!"
        println "=" * 60
    }
}

// –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ –∑–∞–¥–∞—á–∏ –≤ build.gradle

// –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è Inno Setup
task prepareInnoSetupFiles {
    doLast {
        def installerDir = file("${buildDir}/installer")
        installerDir.mkdirs()
        
        // –ö–æ–ø–∏—Ä—É–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞ –ò–ó RESOURCES
        def iconFile = file("${projectDir}/src/main/resources/icon.ico")
        if (iconFile.exists()) {
            copy {
                from iconFile
                into installerDir
            }
            println "‚úì –ò–∫–æ–Ω–∫–∞ –∏–∑ resources —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞"
        } else {
            println "‚ö† –ò–∫–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ${iconFile.path}"
            println "  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å: app/src/main/resources/icon.ico"
        }
        
        // –°–æ–∑–¥–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é –∏ readme –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        def licenseFile = new File("${installerDir}/license.txt")
        licenseFile.text = """MusicSearch License Agreement

MusicSearch Application v${version}

This software is provided "as is" without warranty of any kind.
"""
        
        def readmeFile = new File("${installerDir}/readme.txt")
        readmeFile.text = """MusicSearch v${version}

Thank you for installing MusicSearch!
"""
    }
}

// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç Inno Setup
task createInnoSetupScript {
    dependsOn buildWithExe, prepareInnoSetupFiles
    
    doLast {
        def issFile = new File("${buildDir}/installer/setup.iss")
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –í RESOURCES
        def iconExists = file("${projectDir}/src/main/resources/icon.ico").exists()
        
        issFile.text = """[Setup]
AppName=MusicSearch
AppVersion=${version}
AppVerName=MusicSearch ${version}
AppPublisher=MusicSearch
AppPublisherURL=https://github.com/your-repo
AppSupportURL=https://github.com/your-repo/issues
AppUpdatesURL=https://github.com/your-repo/releases
DefaultDirName={autopf}\\\\MusicSearch
DefaultGroupName=MusicSearch
AllowNoIcons=yes
OutputDir=..\\\\distributions
OutputBaseFilename=MusicSearchSetup
${iconExists ? 'SetupIconFile=icon.ico' : '; SetupIconFile=icon.ico'}
Compression=lzma
SolidCompression=yes
WizardStyle=modern
DisableWelcomePage=no
DisableDirPage=no
DisableProgramGroupPage=no

[Languages]
Name: "russian"; MessagesFile: "compiler:Languages\\\\Russian.isl"
Name: "english"; MessagesFile: "compiler:Default.isl"

[Tasks]
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

[Files]
Source: "..\\\\portable-exe\\\\MusicSearch\\\\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

[Icons]
Name: "{group}\\\\MusicSearch"; Filename: "{app}\\\\MusicSearch.exe"
Name: "{group}\\\\{cm:UninstallProgram,MusicSearch}"; Filename: "{uninstallexe}"
Name: "{autodesktop}\\\\MusicSearch"; Filename: "{app}\\\\MusicSearch.exe"; Tasks: desktopicon

[Run]
Filename: "{app}\\\\MusicSearch.exe"; Description: "{cm:LaunchProgram,MusicSearch}"; Flags: nowait postinstall skipifsilent

[UninstallDelete]
Type: filesandordirs; Name: "{app}"
"""
        
        println "–°–∫—Ä–∏–ø—Ç Inno Setup —Å–æ–∑–¥–∞–Ω: ${issFile}"
        if (iconExists) {
            println "‚úì –ò–∫–æ–Ω–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞"
        } else {
            println "‚ö† –ò–∫–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ resources. –î–æ–±–∞–≤—å—Ç–µ app/src/main/resources/icon.ico"
        }
    }
}

// –°–æ–∑–¥–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —Å –ø–æ–º–æ—â—å—é Inno Setup
task buildInnoInstaller(type: Exec) {
    dependsOn createInnoSetupScript
    
    def issFile = "${buildDir}/installer/setup.iss"
    
    commandLine 'iscc', issFile
    
    doFirst {
        println "–°–æ–∑–¥–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞ —Å –ø–æ–º–æ—â—å—é Inno Setup..."
    }
    
    doLast {
        println "‚úÖ Inno Setup —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —Å–æ–∑–¥–∞–Ω!"
        println "üì¶ –§–∞–π–ª: build/distributions/MusicSearchSetup.exe"
    }
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
task buildInstaller {
    dependsOn buildInnoInstaller
    doLast {
        println "=" * 60
        println "üéâ –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –£–°–¢–ê–ù–û–í–©–ò–ö –°–û–ó–î–ê–ù!"
        println "üì¶ –§–∞–π–ª: build/distributions/MusicSearchSetup.exe"
        println ""
        println "üìã –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫:"
        println "   ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ Program Files"
        println "   ‚úÖ –Ø—Ä–ª—ã–∫–∏ –≤ –º–µ–Ω—é –ü—É—Å–∫ –∏ –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª"
        println "   ‚úÖ –ó–∞–ø–∏—Å—å –≤ —Ä–µ–µ—Å—Ç—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
        println "   ‚úÖ –†—É—Å—Å–∫–∏–π –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫–∏"
        println "   ‚úÖ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
        println ""
        println "üöÄ –î–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è:"
        println "   –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞–π—Ç–µ —Ñ–∞–π–ª MusicSearchSetup.exe –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!"
        println "=" * 60
    }
}

// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏—è, —Å–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é
task buildMinimalInstaller(type: Exec) {
    dependsOn buildWithExe
    
    def issFile = "${buildDir}/minimal-setup.iss"
    
    doFirst {
        new File(issFile).text = """[Setup]
AppName=MusicSearch
AppVersion=${version}
AppPublisher=MusicSearch
DefaultDirName={autopf}\\\\MusicSearch
DefaultGroupName=MusicSearch
OutputDir=../distributions
OutputBaseFilename=MusicSearchSetup
Compression=lzma
SolidCompression=yes

[Files]
Source: "../portable-exe/MusicSearch/*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs

[Icons]
Name: "{group}\\\\MusicSearch"; Filename: "{app}\\\\MusicSearch.exe"
Name: "{autodesktop}\\\\MusicSearch"; Filename: "{app}\\\\MusicSearch.exe"
"""
    }
    
    commandLine 'iscc', issFile
    
    doLast {
        println "‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —Å–æ–∑–¥–∞–Ω!"
    }
}

clean {
    delete 'build/launch4j', 'build/portable-exe', 'build/distributions'
}